    # [중복 실행 방지 강화]
    if st.session_state.get("is_building_rag"):
        return
    
    if (
        SessionManager.get("pdf_processed")
        and not SessionManager.get("pdf_processing_error")
        and SessionManager.get("vector_store") is not None
    ):
        return

    st.session_state.is_building_rag = True
    try:
        if not _ensure_models_are_loaded():
            return

        embedder = SessionManager.get("embedder")

        # [추가] 분석 시작 알림
        SystemNotifier.loading(f"'{file_name}' 분석 시작")

        # 실시간 상태 박스 업데이트를 위한 콜백 정의 (이제 내부 로그만 사용)
        def sync_ui():
            pass

        # [Lazy Import]
        from core.rag_core import build_rag_pipeline

        # RAG 파이프라인 빌드 (내부에서 상세 로그 기록 및 UI 동기화)
        success_message, cache_used = build_rag_pipeline(
            uploaded_file_name=file_name,
            file_path=file_path,
            embedder=embedder,
            on_progress=sync_ui,
        )

        SessionManager.add_message("system", success_message)
        SessionManager.add_message("system", "READY_FOR_QUERY")

    except Exception as e:
        logger.error(f"RAG 빌드 실패: {e}", exc_info=True)
        error_msg = f"문서 처리 중 오류가 발생했습니다: {str(e)}"
        SessionManager.set("pdf_processing_error", error_msg)
        SessionManager.set("pdf_processed", True) # 분석 프로세스 종료(실패) 표시
        SessionManager.add_message("system", f"❌ {error_msg}")
    finally:
        st.session_state.is_building_rag = False
