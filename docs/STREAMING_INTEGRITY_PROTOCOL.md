# ğŸ“‹ RAG ì‹œìŠ¤í…œ ìŠ¤íŠ¸ë¦¬ë° ë° ì¶œë ¥ ë¬´ê²°ì„± í”„ë¡œí† ì½œ (Streaming & Integrity Protocol)

ë³¸ ë¬¸ì„œëŠ” ë‹µë³€ ìƒì„± ì‹œ ë°œìƒí•˜ëŠ” **ì¤‘ë³µ ì¶œë ¥(Double Printing)** ë° **ìŠ¤íŠ¸ë¦¬ë° ì§€ì—°(Buffering)** ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ê¸°ìˆ ì  í‘œì¤€ê³¼ êµ¬í˜„ ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤.

---

## 1. ì£¼ìš” ë°œìƒ ë¬¸ì œ ë° ì›ì¸ ë¶„ì„

### 1.1 ì¤‘ë³µ ì¶œë ¥ (Double Printing)
- **ì¦ìƒ**: ë™ì¼í•œ ë‹µë³€ ê¸€ìê°€ ë‘ ë²ˆì”© ë°˜ë³µí•´ì„œ ì¶œë ¥ë¨ (ì˜ˆ: "ì•ˆì•ˆë…•ë…•í•˜í•˜ì„¸ì„¸ìš”ìš”").
- **ì›ì¸**: LangChainì˜ `astream_events` ì‚¬ìš© ì‹œ `on_chat_model_stream`ê³¼ `on_parser_stream` ì´ë²¤íŠ¸ê°€ ë™ì¼í•œ í† í°ì„ ê°ê° ë³„ë„ë¡œ ë°œìƒì‹œí‚¤ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. UIì—ì„œ ë‘ í†µë¡œë¥¼ ëª¨ë‘ ìˆ˜ì‹ í•˜ë©´ ì¤‘ë³µì´ ë°œìƒí•©ë‹ˆë‹¤.

### 1.2 ìŠ¤íŠ¸ë¦¬ë° ì§€ì—° (Blocky Output)
- **ì¦ìƒ**: ë‹µë³€ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë‚˜ì˜¤ì§€ ì•Šê³ , í•œì°¸ ê¸°ë‹¤ë¦° í›„ í•œêº¼ë²ˆì— "í„±" í•˜ê³  ì¶œë ¥ë¨.
- **ì›ì¸**: LangGraph ë…¸ë“œ ë‚´ë¶€ì—ì„œ í† í°ì„ ìˆ˜ë™ìœ¼ë¡œ ì†Œë¹„(`_consume_stream`)í•˜ë©´, í•´ë‹¹ ë…¸ë“œê°€ ì™„ì „íˆ ì¢…ë£Œë˜ê¸° ì „ê¹Œì§€ í‘œì¤€ ì´ë²¤íŠ¸ê°€ ìƒìœ„ ë£¨í”„ë¡œ ì „íŒŒë˜ì§€ ì•Šê³  ë…¸ë“œ ë‚´ë¶€ì— "ê°‡íˆê²Œ" ë©ë‹ˆë‹¤.

---

## 2. í‘œì¤€ ì•„í‚¤í…ì²˜ (The Golden Rule)

í˜„ì¬ ì‹œìŠ¤í…œì€ **"ì „ìš© ì»¤ìŠ¤í…€ í†µë¡œ ë‹¨ì¼í™”"** ì „ëµì„ í†µí•´ ë‘ ë¬¸ì œë¥¼ ë™ì‹œì— í•´ê²°í•©ë‹ˆë‹¤.

### ê·œì¹™ 1: Core ì—”ì§„ì€ ì „ìš© ì´ë²¤íŠ¸ë¥¼ ë°œì†¡í•œë‹¤
- `src/core/graph_builder.py`ì˜ `generate_response` ë…¸ë“œ ë‚´ì—ì„œ í† í°ì´ ìƒì„±ë  ë•Œë§ˆë‹¤ `adispatch_custom_event`ë¥¼ í†µí•´ **`response_chunk`**ë¼ëŠ” ì´ë¦„ì˜ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.
- **ì´ìœ **: ë…¸ë“œ ë‚´ë¶€ ë£¨í”„ì—ì„œ ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ì˜ë©´ ë…¸ë“œ ì¢…ë£Œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ìƒìœ„ ë£¨í”„ë¡œ ì¦‰ì‹œ ì „íŒŒë©ë‹ˆë‹¤ (ì‹¤ì‹œê°„ì„± í™•ë³´).

### ê·œì¹™ 2: UIëŠ” ì „ìš© ì´ë²¤íŠ¸ë§Œ ìˆ˜ì‹ í•œë‹¤
- `src/ui/ui.py`ì˜ ìˆ˜ì‹  ë£¨í”„ëŠ” ì˜¤ì§ `on_custom_event` ì¤‘ ì´ë¦„ì´ `response_chunk`ì¸ ê²ƒë§Œ í•„í„°ë§í•˜ì—¬ `full_response`ì— ë”í•©ë‹ˆë‹¤.
- **ì´ìœ **: í‘œì¤€ ì´ë²¤íŠ¸(`on_chat_model_stream` ë“±)ë¥¼ ì˜ë„ì ìœ¼ë¡œ ë¬´ì‹œí•¨ìœ¼ë¡œì¨ ì¤‘ë³µ ë°œìƒ ê°€ëŠ¥ì„±ì„ 0%ë¡œ ì°¨ë‹¨í•©ë‹ˆë‹¤.

---

## 3. í•µì‹¬ ì½”ë“œ ë ˆí¼ëŸ°ìŠ¤

### Core (ë°œìƒë¶€: `src/core/graph_builder.py`)
```python
# ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ìœ ì§€í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ í† í°ì„ ë°–ìœ¼ë¡œ ë˜ì ¸ì•¼ í•¨
if (current_time - last_emit_time > 0.05) or len(buffer) >= 5:
    await adispatch_custom_event(
        "response_chunk",
        {"chunk": buffer},
        config=config,
    )
    buffer = ""
    last_emit_time = current_time
```

### UI (ìˆ˜ì‹ ë¶€: `src/ui/ui.py`)
```python
# ë‹¤ë¥¸ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œí•˜ê³  ì˜¤ì§ response_chunkë§Œ ìˆ˜ì§‘í•¨
if kind == "on_custom_event" and name == "response_chunk":
    chunk_text = data.get("chunk")
    
if chunk_text:
    full_response += chunk_text
    # ì´í›„ ë Œë”ë§ ë¡œì§ ìˆ˜í–‰
```

---

## 4. ê¸ˆì§€ ì‚¬í•­ (Anti-Patterns)

1.  âŒ **ì¤‘ë³µ ìˆ˜ì‹  ê¸ˆì§€**: UI ì½”ë“œì—ì„œ `on_parser_stream`ê³¼ `on_custom_event`ë¥¼ ë™ì‹œì— ìˆ˜ì‹ í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
2.  âŒ **ë…¸ë“œ ë‚´ë¶€ ë¸”ë¡œí‚¹ ê¸ˆì§€**: `generate_response` ë…¸ë“œ ë‚´ì—ì„œ `adispatch_custom_event` ì—†ì´ ë£¨í”„ë§Œ ëŒë¦¬ë©´ ìŠ¤íŠ¸ë¦¬ë°ì´ ëŠê¹ë‹ˆë‹¤.
3.  âŒ **ë¬´ë¶„ë³„í•œ sleep ì œê±°**: ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ ë‚´ì— ë¶ˆí•„ìš”í•œ `asyncio.sleep(0.01)` ë“±ì„ ë„£ì§€ ë§ˆì‹­ì‹œì˜¤. ì´ë¯¸ 0.03ì´ˆ ì“°ë¡œí‹€ë§ì´ UI ë Œë”ë§ ë¶€í•˜ë¥¼ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

---

## 5. ê²€ì¦ ë°©ë²•
ê¸°ëŠ¥ ìˆ˜ì • í›„ì—ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.
- `python tests/verify_streaming_realtime.py`: ì‹¤ì‹œê°„ íƒ€ì„ë¼ì¸ ë° ì¤‘ë³µ ì—¬ë¶€ ì²´í¬.
