# μ¤νΈλ¦¬λ° λ° μ‚¬κ³  κ³Όμ •(Thinking) μµμΆ… μ •μƒν™” λ³΄κ³ μ„

**λ‚ μ§**: 2026-01-26  
**μƒνƒ**: β… ν•΄κ²° μ™„λ£ (Resolved)

---

## 1. ν•΄κ²°λ μ΄μ μ”μ•½

### 1.1 μ‚¬κ³  κ³Όμ •(Thinking) μ¶λ ¥ λ„λ½ λ° μ¶©λ
*   **μ›μΈ**: 
    1.  Ollama λ¨λΈ(`qwen3:4b` λ“±)μ μ‚¬κ³  λ°μ΄ν„°κ°€ λΉ„ν‘μ¤€ ν•„λ“(`message.thinking`)μ— λ‹΄κ²¨ μμ–΄ LangChain κΈ°λ³Έ ν΄λμ¤κ°€ μ΄λ¥Ό λ¬΄μ‹ν•¨.
    2.  UI μ½”λ“μ—μ„ Streamlitμ— μ΅΄μ¬ν•μ§€ μ•λ” API(`expander.update()`)λ¥Ό νΈμ¶ν•μ—¬ λ‹µλ³€ μƒμ„± μ¤‘ λ°νƒ€μ„ μ¤λ¥ λ°μƒ.
*   **ν•΄κ²°**: 
    1.  `DeepThinkingChatOllama` μ»¤μ¤ν…€ ν΄λμ¤λ¥Ό κµ¬ν„ν•μ—¬ μ‚¬κ³  λ°μ΄ν„°λ¥Ό `additional_kwargs`λ΅ μΊ΅μ²ν•λ„λ΅ κ°μ„ .
    2.  UI μ½”λ“μ—μ„ μ¶©λ μ›μΈμΈ `.update()`λ¥Ό μ κ±°ν•κ³ , `st.empty()` μ»¨ν…μ΄λ„λ¥Ό μ‚¬μ©ν•μ—¬ μƒνƒλ¥Ό μ—…λ°μ΄νΈν•λ„λ΅ λ³€κ²½.

### 1.2 μ¤‘λ³µ μ¶λ ¥ λ° μ¤νΈλ¦¬λ° μ§€μ—°
*   **μ›μΈ**: ν‘μ¤€ `on_chat_model_stream`κ³Ό μ»¤μ¤ν…€ μ΄λ²¤νΈλ¥Ό λ™μ‹μ— μμ‹ ν•μ—¬ λ°μ΄ν„°κ°€ μ¤‘λ³µ λ λ”λ§λ¨.
*   **ν•΄κ²°**: "μ¤νΈλ¦¬λ° λ¬΄κ²°μ„± ν”„λ΅ν† μ½"μ„ μ μ©ν•μ—¬ **μ»¤μ¤ν…€ μ΄λ²¤νΈ(`response_chunk`) ν†µλ΅λ΅λ§ λ°μ΄ν„°λ¥Ό μμ‹ **ν•λ„λ΅ λ‹¨μΌν™”.

---

## 2. μ£Όμ” λ³€κ²½ νμΌ λ° λ΅μ§

### π“„ `src/core/custom_ollama.py` (μ‹ κ·)
*   `ChatOllama`λ¥Ό μƒμ†λ°›μ•„ `_astream` μ¤λ²„λΌμ΄λ”©.
*   Ollama APIμ `part["message"]["thinking"]` λ°μ΄ν„°λ¥Ό μ¶”μ¶ν•μ—¬ μ‹¤μ‹κ°„ μ „μ†΅ μ§€μ›.

### π“„ `src/ui/ui.py`
*   `astream_events` λ²„μ „μ„ `v2`λ΅ μ—…λ°μ΄νΈ.
*   `on_custom_event`λ§ ν•„ν„°λ§ν•μ—¬ μ‚¬κ³  κ³Όμ •κ³Ό λ‹µλ³€μ„ λ¶„λ¦¬ λ λ”λ§.
*   λ‹µλ³€ μ™„λ£ ν›„ μ‚¬κ³  κ³Όμ • λ°•μ¤λ¥Ό μλ™μΌλ΅ λ‹«ν μƒνƒ(`expanded=False`)λ΅ μ¬λ λ”λ§ν•μ—¬ UI μ •λ¦¬.

### π“„ `src/core/graph_builder.py`
*   `generate_response` λ…Έλ“μ—μ„ μ‚¬κ³  κ³Όμ •κ³Ό ν…μ¤νΈ μ΅°κ°μ„ ν•λ‚μ μ»¤μ¤ν…€ μ΄λ²¤νΈλ΅ ν¨ν‚¤μ§•ν•μ—¬ λ°μ†΅.

---

## 3. κ²€μ¦ κ²°κ³Ό (`tests/verify_streaming_realtime.py`)

*   **μ‹¤μ‹κ°„μ„±**: μ‚¬κ³  κ³Όμ •(THOUGHT) -> μΌλ° λ‹µλ³€(Chunk) μμ„λ΅ μ§€μ—° μ—†μ΄ μ‹¤μ‹κ°„ μμ‹  ν™•μΈ.
*   **λ¬΄κ²°μ„±**: ν…μ¤νΈ μ¤‘λ³µ λ°μƒ 0κ±΄, λ°νƒ€μ„ μ—λ¬ 0κ±΄.
*   **μµμΆ… κ²°κ³Ό μƒν”**:
    ```
    [0.87s] THOUGHT: 'We are counting...'
    ...
    [93.74s] Chunk: '1 ... 2 ... 3 ... 4 ... 5'
    β… PASS: μ¤νΈλ¦¬λ°μ΄ μ‹¤μ‹κ°„μΌλ΅ μ¤‘λ³µ μ—†μ΄ μ™„λ²½ν•κ² μ‘λ™ν•©λ‹λ‹¤!
    ```

---

## 4. ν–¥ν›„ μ μ§€λ³΄μ μ§€μΉ¨
*   μ¤νΈλ¦¬λ° λ΅μ§ μμ • μ‹ λ°λ“μ‹ `tests/verify_streaming_realtime.py`λ¥Ό μ‹¤ν–‰ν•μ—¬ μ‚¬κ³  κ³Όμ •κ³Ό λ‹µλ³€μ΄ λ¨λ‘ μ΅νλ”μ§€ ν™•μΈν•μ‹­μ‹μ¤.
*   μƒλ΅μ΄ Ollama λ¨λΈ λ„μ… μ‹ `thinking` ν‚¤λ¥Ό μ‚¬μ©ν•λ”μ§€ μ—¬λ¶€λ¥Ό `src/core/custom_ollama.py`μ—μ„ μ²΄ν¬ν•μ‹­μ‹μ¤.